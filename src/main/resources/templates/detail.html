<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ê²Œì‹œê¸€ ìƒì„¸í˜ì´ì§€</title>
  <link rel="stylesheet" href="css/detail.css">
  <link rel="stylesheet" href="css/detail.css">
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
  <th:block th:include="header.html"></th:block>

</head>

<body>
<div id="wrapdiv">
  <div class="content">
    <div class="view_head">
      <div class="category" th:text="${board.bcategory}"></div>
      <div class="content_title" th:text="${board.btitle}"></div>
      <div class="minfo">
        <span th:text="${board.mbid.mcname}"></span> Â·
        <span id="writer" th:text="${board.mbid.mid}"></span>
      </div>
      <div class="binfo">

        <span class="boardInfo" th:text="|ì¡°íšŒìˆ˜ ${board.bview}|"></span> Â·
        <span class="boardInfo" th:text="'ğŸ’¬ '+ ${board.bcomment}"></span>
        <!--íƒ€ì„ë¦¬í”„ì—ì„œ onclick ì´ë²¤íŠ¸ ë°œìƒì‹œ ì‹¤í–‰í•  í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„° ë„˜ê¸°ëŠ” ë°©ë²•. th:ë³€ìˆ˜ëª…=ê°’ -> this.getAttribute(ë³€ìˆ˜ëª…)-->
        <span class="boardInfo likeBtn" th:text="'ğŸ‘ '+ ${board.blike}"
              th:target="board"
              th:targetNo="${board.bno}"
              onclick="addLike(this.getAttribute('target'), this.getAttribute('targetNo'))"></span>
      </div>
    </div>
  </div>
  <div>
    <div class="bcontent" th:text="${board.bcontent}"></div>
    <div>
      <!--ë¡œê·¸ì¸í•œ ê³„ì •ê³¼ ê¸€ ì‘ì„±ìê°€ ë™ì¼í•  ê²½ìš°, ìˆ˜ì •, ì‚­ì œë²„íŠ¼ ì¶œë ¥-->
      <th:block th:if="${member!=null}">
        <th:block th:if="${#strings.equals(member.mid, board.mbid.mid)}">
          <button id="upbtn">ìˆ˜ì •</button>
          <button id="delbtn">ì‚­ì œ</button>
        </th:block>
      </th:block>
    </div>


    <!--   ì²¨ë¶€íŒŒì¼-->
    <div id="filebox">
      <div class="file">FILES</div>
<!--ì²¨ë¶€íŒŒì¼ ì—†ëŠ” ê²½ìš°-->
      <th:block th:if="${#lists.isEmpty(bfList)}">
        ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
      </th:block>
      <!--ì²¨ë¶€íŒŒì¼ì´ ì¡´ì¬í•  ê²½ìš°-->
      <th:block th:unless="${#lists.isEmpty(bfList)}">
        <th:block th:each="bf:${bfList}">
          <a th:href="@{download(fsysname=${bf.fsysname},foriname=${bf.foriname})}">
            <span class="file-title" th:text="${bf.foriname}"></span>
          </a>
        </th:block>
      </th:block>
    </div>


    <!--ëŒ“ê¸€-->
    <div class="reply_wrap">
<!--      ë¡œê·¸ì¸ ìƒíƒœì¼ë•Œ ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥-->
      <th:block th:if="${session.member}!=null">
        <div class="reply">
          <form action="cWriteProc" method="post" id="replyfrm" class="reply_form">
            <input type="hidden" name="mccname" th:value="${session.member.mcname}">
            <input type="hidden" name="bcno" th:value="${session.board.bno}">
            <input type="hidden" name="mcid" th:value="${session.member.mid}">
            <input class="plzlogin" type="text" name="ccontent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
            <Button class="redBtn">ëŒ“ê¸€ì‘ì„±</Button>
          </form>
        </div>
      </th:block>
<!--      ë¹„ë¡œê·¸ì¸ì‹œ ì¶œë ¥í•  ë¬¸êµ¬-->
      <th:block th:unless="${session.member}!=null">
        <input class="plzlogin" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì‹œë ¤ë©´ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”" readonly>
        <button class="login" id="login">ë¡œê·¸ì¸</button>

      </th:block>
    </div>

  </div>
  <div class="comment_area"></div>
  <button id="moreComment">ëŒ“ê¸€ ë”ë³´ê¸°</button>

</div>
</body>
<th:block th:include="footer.html"></th:block>
<script th:inline="javascript">
<!--    ì„œë²„ì—ì„œ ì „ë‹¬í•œ ë©”ì‹œì§€ê°€ ì¡´ì¬í•  ê²½ìš°, alertìœ¼ë¡œ ì¶œë ¥-->
    let msg = [[${msg}]];
    if (msg != null) {
        alert(msg);
    }

    //ë¡œê·¸ì¸í•œ ê³„ì •ê³¼ ê¸€ ì‘ì„±ì ì¼ì¹˜ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•´,
    //ë¡œê·¸ì¸í•œ ê³„ì •ì„ ë³€ìˆ˜ì— ì €ì¥
    let loginUser = [[${member}]];

    //í˜„ì¬ ê¸€ ë²ˆí˜¸ ì €ì¥
    let nowBno = [[${session.board.bno}]]

    let cPageNum = 1;
    //ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    getComment(cPageNum, nowBno)

//ì¢‹ì•„ìš” +1
    function addLike(target, targetNo) {
        let URL;
        if (target === "board") {
            URL = "likeBoard?bno=" + targetNo;
        } else {
            URL = "likeComment?cno=" + targetNo;
        }
        window.location.href = URL;
    }

    //ëŒ“ê¸€ 5ê°œì”© ì¶œë ¥
    function getComment(cPageNum, nowBno) {

        console.log("getTopicList")
        let nowDate = new Date().getTime();
        $.ajax({
            type: 'get',
            url: "getCommentList",
            dataType: "JSON",
            data: {
                'cPageNum': cPageNum,
                'bno': nowBno
            },
            success: function (commentList) {
              //ë¶ˆëŸ¬ì˜¨ ëŒ“ê¸€ì´ 5ê°œ ë¯¸ë§Œì¼ ë•Œ(ë”ì´ìƒì˜ ëŒ“ê¸€ì´ ì—†ì„ë•Œ), ëŒ“ê¸€ ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                if (commentList.length < 5) {
                    $("#moreComment").addClass("hidden");
                } else {
                    $("#moreComment").removeClass("hidden");
                }

                $.each(commentList, function (idx, comment) {
                    //ê²Œì‹œê¸€ì— ì¶œë ¥í•  ë¬¸ìì—´ì„ ì €ì¥í•  ë³€ìˆ˜
                    let fromNow;
                    //ê²Œì‹œê¸€ ì‘ì„± ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                    let writtenDate = new Date(comment.cdate).getTime();
                    //í˜„ì¬ì‹œê°„ê³¼ ê²Œì‹œê¸€ ì‘ì„±ì‹œê°„ì˜ ì°¨ì´ë¥¼ ë¶„ë‹¨ìœ„ë¡œ í™˜ì‚°
                    let timeGap = (nowDate - writtenDate) / 1000 / 60;
                    //1ë¶„ì´ë‚´ -> ë°©ê¸ˆì „
                    if (timeGap < 1) {
                        fromNow = "ë°©ê¸ˆì „";
                    }
                    //1ì‹œê°„ ì´ë‚´ -> xë¶„ ì „
                    else if (1 <= timeGap && timeGap < 60) {
                        fromNow = Math.floor(timeGap) + "ë¶„ ì „";
                    }
                    //í•˜ë£¨ ì´ë‚´-> xì‹œê°„ ì „
                    else if (60 <= timeGap && timeGap < 60 * 24) {
                        fromNow = Math.floor(timeGap / 60) + "ì‹œê°„ ì „";
                    }
                    //í•œë‹¬ ì´ë‚´ -> xì¼ ì „
                    else if (60 * 24 <= timeGap && timeGap < 60 * 24 * 30) {
                        fromNow = Math.floor(timeGap / 60 / 24) + "ì¼ ì „";
                    }
                    //1ë…„ì´ë‚´ -> xë‹¬ ì „
                    else if (60 * 24 * 30 <= timeGap && timeGap < 60 * 24 * 30 * 12) {
                        fromNow = Math.floor(timeGap / 60 / 24 / 30) + "ë‹¬ ì „";
                    }
                    //1ë…„ ì´ìƒ -> xë…„ì „
                    else {
                        fromNow = Math.floor(timeGap / 60 / 24 / 30 / 12) + "ë…„ ì „";
                    }

                    let $commentWrap = $('<div class="comment_wrap">').appendTo('.comment_area');
                    let $infoWrap = ($commentWrap).append('<div class="info_wrap">');

                    $('<span class="c_company">').html(comment.mcid.mcname + " Â· ").appendTo($commentWrap);
                    $('<span class="c_writer">').html(comment.mcid.mid).appendTo($commentWrap);
                    $('<span class="c_content">').html(comment.ccontent).appendTo($commentWrap);

                    //ì¢‹ì•„ìš” ë²„íŠ¼ onclick ì´ë²¤íŠ¸ ë°œìƒ ì‹œ, ì¢‹ì•„ìš” ì¶”ê°€ í•¨ìˆ˜ ì§€ì •
                    $('<span class="c_info likeBtn" >').html("ğŸ‘ : " + comment.clike).appendTo($infoWrap).click(
                        () => addLike("comment", comment.cno));
                    $('<span class="c_date c_info">').html(fromNow).appendTo($infoWrap);
                    $('<span class="hidden">').html(comment.mcid.mid).appendTo($commentWrap);
                    //ë¡œê·¸ì¸í•œ ê³„ì •ê³¼ ëŒ“ê¸€ ì‘ì„±ìê°€ ë™ì¼í•  ê²½ìš°, ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ ì¶œë ¥
                    loginUser !== null ? (loginUser.mid === comment.mcid.mid
                            ? $('<button class="deleteCommentBtn">').text("ëŒ“ê¸€ ì‚­ì œ").appendTo($infoWrap)
                            : null)
                        : null
                    $('<button class=" hidden">').text(comment.cno).appendTo($infoWrap);

                });
            },
            error: function (error) {
                console.log(error)
            }
        });
    }

    //ëŒ“ê¸€ ì‚­ì œ
    $(document).on("click", ".deleteCommentBtn", function () {
        let checkDel = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        if (checkDel) {
            location.href = "cDeleteProc?cno=" + $(this).next().text();
        } else {
            alert("ì‚­ì œê°€ ì·¨ì†ŒëìŠµë‹ˆë‹¤.")
        }
    })

  //ëŒ“ê¸€ ë”ë³´ê¸°
    $("#moreComment").click(function () {
        cPageNum++
        console.log("moreComment" + cPageNum)
        getComment(cPageNum, nowBno)
    })

  //ë¡œê·¸ì¸ í˜ì´ì§€ ì´ë™
    $("#login").click(function () {
            location.href = "login"
        }
    )

    //ê²Œì‹œê¸€ ìˆ˜ì •
    $("#upbtn").click(function () {
        location.href = "updateFrm?bno=" + nowBno;
    });

    //ê²Œì‹œê¸€ ì‚­ì œ
    $("#delbtn").click(function () {
        let checkDel = confirm("ê¸€ ì œëª© '" + [[${board.btitle}]] + "'ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        if (checkDel) {
            location.href = "delete?bno=" + nowBno;
        } else {
            alert("ì‚­ì œê°€ ì·¨ì†ŒëìŠµë‹ˆë‹¤.")
        }
    });


</script>
</html>