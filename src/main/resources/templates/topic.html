<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link rel="stylesheet" href="css/topic.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/footer.css">

  <script src="https://code.jquery.com/jquery-3.6.1.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
          crossorigin="anonymous"></script>
</head>
<body>
<header>
  <th:block th:include="header.html"></th:block>
</header>
<section>
  <div class="topic_wrap">
    <ol id="categoryList">
      <li>ì „ì²´</li>
      <li>ë² ìŠ¤íŠ¸</li>
      <li>ììœ ê²Œì‹œíŒ</li>
      <li>íšŒì‚¬ìƒí™œ</li>
      <li>ì£¼ì‹/íˆ¬ì</li>
      <li>ì¸/ì—°ì• </li>
      <li>ê²°í˜¼</li>
      <li>ë¼ì´í”„</li>
    </ol>
  </div>
  <br>

  <span id="categoryPrint"></span>
  <!--ì „ì²´ ë˜ëŠ” ë² ìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ê°€ ì•„ë‹ ê²½ìš°, new hot ì¶œë ¥-->
  <div class="nhlogo hidden">
    <span>new</span>
    <span>hot</span>
  </div>
  <div class="post_area">


  </div>

</section>
<footer>
  <th:block th:include="footer.html"></th:block>
</footer>
</body>
<script th:inline="javascript">
    <!--ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì„¸ì§€ê°€ ì¡´ì¬í•  ê²½ìš°, ì•Œë¦¼ ì¶œë ¥-->
    let m = [[${msg}]];
    if (m !== null) {
        alert(m);
    }

    //í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let pageNum = 1;
    //ì¹´í…Œê³ ë¦¬ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let category;


    $(function () {

        //ì„œë²„ì—ì„œ ë°›ì€ categoryì˜ ê°’ì´ nullì´ ì•„ë‹ê²½ìš°, í•´ë‹¹ categoryì˜ë¥¼ ì €ì¥
        if (sessionStorage.getItem("category") != null) {
            category = sessionStorage.getItem("category");

            //ì¹´í…Œê³ ë¦¬ê°€ ì „ì²´ ë˜ëŠ” ë² ìŠ¤íŠ¸ê°€ ì•„ë‹ ê²½ìš°, new, hot ì¶œë ¥.(ìƒˆë¡œê³ ì¹¨ ì‹œ ìƒíƒœìœ ì§€)
            if (category !== "ì „ì²´" && category !== "ë² ìŠ¤íŠ¸") {
                $('.nhlogo').removeClass("hidden");
            } else {
                $('.nhlogo').addClass("hidden");
            }

            //sessionStorageì— ì €ì¥ëœ ì¹´í…Œê³ ë¦¬ì™€ ì¼ì¹˜í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë©”ë‰´ë¥¼ ì²´í¬ìƒíƒœë¡œ ì¶œë ¥(ìƒˆë¡œê³ ì¹¨ ì‹œ ìƒíƒœìœ ì§€)
            let $categoryList = $('#categoryList').children("li")
            $.each($categoryList, function (idx, li) {
                if (li.innerHTML === category) {
                    li.classList.add("checkedMenu")
                }
            })
        }
        //ì„œë²„ì—ì„œ ë°›ì€ categoryì˜ ê°’ì´ nullì´ë©´, categoryì— 'ì „ì²´' ì €ì¥
        else {
            category = "ì „ì²´"
        }


        //ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ëŠ” ê²Œì‹œê¸€ ê°€ì ¸ì˜¤ê¸°
        getTopic(category, pageNum)


        //ì¹´í…Œê³ ë¦¬ë¥¼ í´ë¦­í–ˆì„ ë•Œ ì²˜ë¦¬
        $('li').click(function () {
            //ì „ì²´ ì¹´í…Œê³ ë¦¬ ë©”ë‰´ì˜ í´ë˜ìŠ¤ ì œê±°
            $(this).parent().children("li").removeClass("checkedMenu")
            //í´ë¦­í•œ ì¹´í…Œê³ ë¦¬ì—ë§Œ í´ë˜ìŠ¤ ì¬ ë¶€ì—¬
            $(this).addClass("checkedMenu")
            //í˜ì´ì§€ë²ˆí˜¸ë¥¼ nullë¡œ ì´ˆê¸°í™”
            pageNum = 1;
            //í´ë¦­í•œ ì¹´í…Œê³ ë¦¬ì˜ textë¥¼ sessionStorage ë° category ë³€ìˆ˜ì— ì €ì¥
            sessionStorage.setItem("category", $(this).text());

            category = $(this).text();

            //ì¹´í…Œê³ ë¦¬ê°€ 'ì „ì²´'ë˜ëŠ” 'ë² ìŠ¤íŠ¸' ê°€ ì•„ë‹ ê²½ìš°, new, hot ì¶œë ¥.
            if (category !== "ì „ì²´" && category !== "ë² ìŠ¤íŠ¸") {
                $('.nhlogo').removeClass("hidden");
            } else {
                $('.nhlogo').addClass("hidden");
            }
            //ê¸°ì¡´ì— ì¶œë ¥í–ˆë˜ ê²Œì‹œê¸€ ì œê±°
            $('.post_area').empty();
            //ìƒˆë¡œìš´ ì¹´í…Œê³ ë¦¬ì˜ ê²Œì‹œê¸€ ì¶œë ¥
            getTopic(category, pageNum)

        });

        //ê²Œì‹œê¸€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function getTopic(category, pageNum, userId) {
            console.log(pageNum);
            //í˜„ì¬ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ ì €ì¥
            let nowDate = new Date().getTime();
            $.ajax({
                    type: 'get',
                    url: "getTopicList",
                    dataType: "JSON",
                    data: {
                        "category": category,
                        "pageNum": pageNum
                    },
                    success: function (topicList) {

                        $.each(topicList, function (idx, board) {
                            //ê²Œì‹œê¸€ì— ì¶œë ¥í•  ë¬¸ìì—´ì„ ì €ì¥í•  ë³€ìˆ˜
                            let fromNow;
                          //ê²Œì‹œê¸€ ì‘ì„± ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                            let writtenDate = new Date(board.bdate).getTime();
                          //í˜„ì¬ì‹œê°„ê³¼ ê²Œì‹œê¸€ ì‘ì„±ì‹œê°„ì˜ ì°¨ì´ë¥¼ ë¶„ë‹¨ìœ„ë¡œ í™˜ì‚°
                            let timeGap = (nowDate - writtenDate) / 1000 / 60;
                          //1ë¶„ì´ë‚´ -> ë°©ê¸ˆì „
                            if (timeGap < 1) {
                                fromNow = "ë°©ê¸ˆì „";
                            }
                            //1ì‹œê°„ ì´ë‚´ -> xë¶„ ì „
                            else if (1 <= timeGap && timeGap < 60) {
                                fromNow = Math.floor(timeGap) + "ë¶„ ì „";
                            }
                            //í•˜ë£¨ ì´ë‚´-> xì‹œê°„ ì „
                            else if (60 <= timeGap && timeGap < 60 * 24) {
                                fromNow = Math.floor(timeGap / 60) + "ì‹œê°„ ì „";
                            }
                            //í•œë‹¬ ì´ë‚´ -> xì¼ ì „
                            else if (60 * 24 <= timeGap && timeGap < 60 * 24 * 30) {
                                fromNow = Math.floor(timeGap / 60 / 24) + "ì¼ ì „";
                            }
                            //1ë…„ì´ë‚´ -> xë‹¬ ì „
                            else if (60 * 24 * 30 <= timeGap && timeGap < 60 * 24 * 30 * 12) {
                                fromNow = Math.floor(timeGap / 60 / 24 / 30) + "ë‹¬ ì „";
                            }
                            //1ë…„ ì´ìƒ -> xë…„ì „
                            else {
                                fromNow = Math.floor(timeGap / 60 / 24 / 30 / 12) + "ë…„ ì „";
                            }

                            //ê²Œì‹œê¸€ëª©ë¡ì„ ì¶œë ¥í•  div ì„ íƒ
                            let $postWrap = $('<div class="post_wrap readPost">').appendTo('.post_area');


                            $('<span class="post_category">').html(board.bcategory).appendTo($postWrap);
                            $('<div class="post_title ">').html('<span >' + board.btitle + '</span>').appendTo($postWrap);
                            $('<div class="post_content ">').html('<span >' + board.bcontent + '</span>').appendTo($postWrap);
                            $('<span class="hidden">').html(board.bno).appendTo($postWrap);

                            //ê° ê²Œì‹œê¸€ì˜ ìƒì„¸ ë‚´ìš©ì„ ì¶œë ¥í•  div ì„ íƒ
                            let $infoWrap = ($postWrap).append('<div class="info_wrap">');

                            $('<span class="post_writer">').html(board.mbid.mcname + " Â· " + board.mbid.mid + '</br>').appendTo($postWrap);
                            $('<span class="post_info">').html("ğŸ‘ : " + board.blike).appendTo($infoWrap);
                            $('<span class="post_info">').html("ğŸ’¬ : " + board.bcomment).appendTo($infoWrap);
                            $('<span class="post_info">').html("ì¡°íšŒìˆ˜ : " + board.bview).appendTo($infoWrap);
                            $('<span class="post_date post_info">').html(fromNow).appendTo($infoWrap);

                        });
                        //ëª©ë¡ ì¶œë ¥ í›„, sessionStorageì— í˜„ì¬ ì¹´í…Œê³ ë¦¬ ì €ì¥
                        sessionStorage.setItem("category", category)
                    },
                    error: function (error) {
                        console.log(error)
                    }
                }
            )
            ;
        }

        //ë¬´í•œí˜ì´ì§• ì²˜ë¦¬
        //$(window).scrollTop() : ìŠ¤í¬ë¡¤ì˜ ìœ„ì¹˜ì— ë”°ë¼ ë³€í•˜ëŠ” ê°’ (ì„¸ë¡œ ì¢Œí‘œ),ìµœìƒë‹¨ 0, ìµœí•˜ë‹¨ ë„ë‹¬ì‹œ ìŠ¤í¬ë¡¤ ê¸¸ì´ê°€ ìµœëŒ€ê°’ì„ ê°€ì§.
        //$(window).height(): ë³´ì—¬ì§€ëŠ” ì°½ì˜ ë†’ì´ ê¸¸ì´
        // $(document).height() : jsp, html ë“± ë¬¸ì„œì˜ ë†’ì´ ê¸¸ì´, ë³´ì—¬ì§€ëŠ” ì°½ì˜ ë†’ì´ ê¸¸ì´ë³´ë‹¤ ë¬¸ì„œì˜ ê¸¸ì´ê°€ ê¸¸ë‹¤ë©´ ìŠ¤í¬ë¡¤ìƒì„±

        $(window).scroll(function () {
            //ë³´ì—¬ì§€ëŠ” ì°½ì˜ ë†’ì´ - ë¬¸ì„œì˜ ë†’ì´ ë§Œí¼ ìŠ¤í¬ë¡¤ì´ ì´ë™í•˜ë©´,
            if (($(window).scrollTop()) === $(document).height() - $(window).height()) {
                //í˜ì´ì§€ ë²ˆí˜¸ 1 ì¦ê°€ í›„, ë‹¤ìŒ í˜ì´ì§€ì˜ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
                pageNum++;
                getTopic(category, pageNum);
            }
        })


        //ê²Œì‹œê¸€ í´ë¦­ì‹œ, í•´ë‹¹ ê¸€ì˜ ìƒì„¸í˜ì´ì§€ ì´ë™
        $(document).on("click", ".readPost", function () {
            let bno = $(this).children('.hidden').text();
            console.log("bno = " + bno)
            location.href = "detail?bno=" + bno;
        })

    })
</script>
</html>